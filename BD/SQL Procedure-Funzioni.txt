----------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION verification(login IN VARCHAR(50), pass IN VARCHAR(50)) 
RETURNS INT AS $verification$
DECLARE
    priority_found INT;
BEGIN
    SELECT priority INTO priority_found
    FROM UTENTE
    WHERE UTENTE.login = verification.login AND UTENTE.password = verification.pass;

    IF FOUND THEN
        RETURN priority_found;
    ELSE
        RETURN -1; -- Utente non trovato
    END IF;
END;
$$
LANGUAGE plpgsql;
----------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION convRuolo(ruoli IN VARCHAR(100)) 
RETURN VARCHAR(20) AS $convRuolo$
DECLARE
	pos INT;
	ruolo VARCHAR(20);
BEGIN
	pos := INSTR(ruoli, '_', 1);
	
	IF pos > 0 THEN
		ruolo := SUBSTR (ruoli, 1, pos - 1);
	ELSE
		ruolo := ruoli;
	END IF;
	
	RETURN ruolo;
END; 
$$
LANGUAGE plpgsql;
----------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER checkPortiere AS
BEFORE INSERT ON goalsubiti
FOR EACH ROW
DECLARE
	ruolo VARCHAR(20);
BEGIN
	ruolo := convRuolo(SELECT R.ruolo FROM RUOLO AS R, CALCIATORE AS C WHERE R.id_giocatore = C.id_giocatore AND C.id_giocatore = NEW.id_giocatore);
	IF ruolo <> 'portiere' THEN
		RAISE EXCEPTION('Il giocatore che stai inserendo non Ã¨ portiere.');
	END IF;
END;
----------------------------------------------------------------------------------------------------------------
CREATE TRIGGER inserimentoRosa
AFTER INSERT ON Militanza
FOR EACH ROW
BEGIN
	INSERT INTO rosa (anno, id_giocatore, squadra)
	VALUES (NEW.inizio, NEW.id_giocatore, NEW.squadra);
END;
----------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION controllaNumGiocatoriFunction() RETURNS TRIGGER AS $$
DECLARE
    numGiocatori INT;
BEGIN
    SELECT COUNT(id_giocatore) INTO numGiocatori
    FROM rosa
    WHERE squadra = NEW.squadra
    GROUP BY squadra, anno;

    IF numGiocatori < 16 THEN
        RAISE EXCEPTION 'La squadra ha troppi pochi giocatori per partecipare alla competizione.';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
----------------------------------------------------------------------------------------------------------------
CREATE TRIGGER controllaNumGiocatori
BEFORE INSERT ON squadra_gioca_in_competizioni_nazionali
FOR EACH ROW
EXECUTE FUNCTION controllaNumGiocatoriFunction();
----------------------------------------------------------------------------------------------------------------
